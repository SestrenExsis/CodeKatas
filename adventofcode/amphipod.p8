pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
-- amphipod
-- by sestrenexsis
-- https://github.com/sestrenexsis/codekatas

-- for advent of code 2021
-- https://adventofcode.com/2021/day/23
_version=1
cartdata("sestrenexsis_amphipod_1")

--[[ save data
 0: lowest score, red
 1: lowest score, orange
 2: lowest score, yellow
 3: lowest score, green
--]]
-->8
function _init()
	-- todo: add defaults on first load
	_row=5
	_col=2
	_moves={0,0,0,0}
	_grab=false
	_grabt=t()
	--[[
	_undos={}
	_m={
		2,5,3,5,5,5,7,5,9,5,11,5,12,5,
		4,6,6,6,8,6,10,6,
		4,7,6,7,8,7,10,7,
	}
	local undo=""
	for i=1,29,2 do
		local m=mget(_m[i],_m[i+1])
		undo=undo
	end
	add(_undos,{"...........dacdcabb",0,0,0,0})
	--]]
	part2()
end

function part1()
	_row=5
	_col=2
	_moves={0,0,0,0}
	_grab=false
	_grabt=t()
	for y=0,15 do
		for x=0,15 do
			local m=mget(x,16+y)
			mset(x,y,m)
		end
	end
end

function part2()
	_row=5
	_col=2
	_moves={0,0,0,0}
	_grab=false
	_grabt=t()
	for y=1,16 do
		for x=1,16 do
			local m=mget(16+x,y)
			mset(x,y,m)
		end
	end
end

function _update()
	local lrw=_row
	local lcl=_col
	-- process inputs
	if btnp(❎) then
		_grab=not _grab
		if _grab then
			_grabt=t()
			if mget(_col,_row)==2 then
				_grab=false
			end
		end
	end
	if btnp(⬆️) then
		_row=max(0,_row-1)
	elseif btnp(⬇️) then
		_row=min(15,_row+1)
	end
	if btnp(⬅️) then
		_col=max(0,_col-1)
	elseif btnp(➡️) then
		_col=min(15,_col+1)
	end
	-- check for collisions
	if lrw!=_row or lcl!=_col then
		local m=mget(_col,_row)
		local f6=fget(m,6)
		local f7=fget(m,7)
		if _grab and f7 then
			_col=lcl
			_row=lrw
		elseif not _grab and not f6 then
			_col=lcl
			_row=lrw
		end
	end
	-- move tiles around
	if _grab then
		if lrw!=_row or lcl!=_col then
			local lm=mget(lcl,lrw)
			mset(_col,_row,lm)
			mset(lcl,lrw,2)
			local m=mget(_col,_row)
			local f0=fget(m,0)
			local f1=fget(m,1)
			local idx=1
			if f0 then idx+=1 end
			if f1 then idx+=2 end
			_moves[idx]+=1
		else
			local m=mget(_col,_row)
			if m>=3 and m<=6 then
				mset(_col,_row,m+6)
			end
		end
	else
		local m=mget(_col,_row)
			if m>=9 and m<=12 then
				mset(_col,_row,m-6)
			end
	end
end

function _draw()
	cls(0)
	map(0,0,0,0,128,128)
	-- draw cursor
	local fm=7
	local tm=(t()-_grabt)
	if _grab and tm%0.5<0.25 then
		fm=8
	end
	spr(fm,8*_col,8*_row)
	-- draw scores
	local x=21
	if _moves[1]>99 then
		x-=8
	elseif _moves[1]>9 then
		x-=4
	end
	print(_moves[1],x,91,11)
	x=17
	if _moves[2]>99 then
		x-=8
	elseif _moves[2]>9 then
		x-=4
	end
	print(_moves[2],x,97,10)
	x=13
	if _moves[3]>99 then
		x-=8
	elseif _moves[3]>9 then
		x-=4
	end
	print(_moves[3],x,103,9)
	x=9
	if _moves[4]>99 then
		x-=8
	elseif _moves[4]>9 then
		x-=4
	end
	print(_moves[4],x,109,8)
	local nrg=_moves[1]
	nrg+=10*_moves[2]
	nrg+=100*_moves[3]
	nrg+=1000*_moves[4]
	print(nrg,45,102,7)
end
__gfx__
00000000777777761111111111111111111111111111111111111111770000770000000018888111199991111aaaa1111bbbb111002222222222222222222200
000000007666666511111111118888111199991111aaaa1111bbbb1170000007077007708888881199999911aaaaaa11bbbbbb11020000000000000000000020
00700700766666651111111118888881199999911aaaaaa11bbbbbb100000000070000708888880199999901aaaaaa01bbbbbb01200222222222222222222002
0007700076676665111dd11118888881199999911aaaaaa11bbbbbb100000000000000008888880199999901aaaaaa01bbbbbb01202000000000000000000202
0007700076665665111dd11118888881199999911aaaaaa11bbbbbb100000000000000008888880199999901aaaaaa01bbbbbb01202000000000000000000202
00700700766666651111111118888881199999911aaaaaa11bbbbbb1000000000700007018888001199990011aaaa0011bbbb001202000000000000000000202
000000007666666511111111118888111199991111aaaa1111bbbb11700000070770077011000011110000111100001111000011202000000000000000000202
00000000655555551111111111111111111111111111111111111111770000770000000011111111111111111111111111111111202000000000000000000202
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000202000000000000000000202
00555500005555000055550005500550055555500055550000555500055555000000000000000000000000000000000000000000202000000000000000000202
05555550055555500555555005500550055555500555555005555550055555500000000000000000000000000000000000000000202000000000000000000202
05555550055555500555555005500550000550000555555005555550055555500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550055005500550000550000550055005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550055005500550000550000550055005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550055005500550000550000550055005500550055005500000000000000000000000000000000000000000202000000000000000000202
05555550055050500555555005555550000550000555555005500550055005500000000000000000000000000000000000000000202000000000000000000202
05555550055050500555550005555550000550000555550005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550000005500550000550000550000005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550000005500550000550000550000005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550000005500550000550000550000005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550000005500550000550000550000005500550055005500000000000000000000000000000000000000000202000000000000000000202
05500550055050500550000005500550055555500550000005555550055555500000000000000000000000000000000000000000200222222222222222222002
05500550055050500550000005500550055555500550000000555500055555000000000000000000000000000000000000000000020000000000000000000020
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002222222222222222222200
__gff__
008040c3c2c1c00000c3c2c1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0d0e0e0e0e0e0e0e0e0e0e0e0e0e0e0f0d0e0e0e0e0e0e0e0e0e0e0e0e0e0e0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000010111213141516170000001f1d00101112131415161700141400001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d30313120212223242526270000001f1d30202122232425262700242400001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01010101010101010101010101001f1d01010101010101010101010101001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01020202020202020202020201001f1d01020202020202020202020201001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01010102010201020102010101001f1d01010105010401050103010101001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000102010201020102010000001f1d00000103010401050106010000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000101010101010101010000001f1d00000103010501060104010000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000106010301040106010000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000101010101010101010000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f1d00000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2d2e2e2e2e2e2e2e2e2e2e2e2e2e2e2f2d2e2e2e2e2e2e2e2e2e2e2e2e2e2e2f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0d0e0e0e0e0e0e0e0e0e0e0e0e0e0e0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000010111213141516170000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d30313120212223242526270000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01010101010101010101010101001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01020202020202020202020201001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d01010105010401050103010101001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000106010301040106010000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000101010101010101010000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d00000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2d2e2e2e2e2e2e2e2e2e2e2e2e2e2e2f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
